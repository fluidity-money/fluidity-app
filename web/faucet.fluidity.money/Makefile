
REPO := faucet.fluidity.money

FRONTEND_SRC_DIR := src
BACKEND_SRC_DIR := cmd

FRONTEND_SRC_TS_DIR := ${FRONTEND_SRC_DIR}
FRONTEND_SRC_SASS_DIR := ${FRONTEND_SRC_DIR}/scss

FRONTEND_SRC_TS := \
	$(shell find ${FRONTEND_SRC_TS_DIR} -name '*ts*')

FRONTEND_SRC := ${FRONTEND_SRC_TS}

FRONTEND_BUILD_DIR := build

FRONTEND_BUILD_INDEX_JS := ${FRONTEND_BUILD_DIR}/index.js
FRONTEND_BUILD_INDEX_HTML := ${FRONTEND_BUILD_DIR}/index.html

include ../../web.mk

FRONTEND_IMAGES_DIR := ${FRONTEND_PUBLIC_DIR}/images

FRONTEND_IMAGES := \
	$(shell find ${FRONTEND_IMAGES_DIR} \
		-name '*.png' \
		-or -name '*.svg')

FRONTEND_PUBLIC_INDEX_HTML := ${FRONTEND_PUBLIC_DIR}/index.html
FRONTEND_PUBLIC_MANIFEST := ${FRONTEND_PUBLIC_DIR}/manifest.json

FRONTEND_BUILD_IMAGES := build-images

${FRONTEND_BUILD_INDEX_HTML}: ${FRONTEND_PUBLIC_INDEX_HTML}
	@cp ${FRONTEND_PUBLIC_INDEX_HTML} ${FRONTEND_BUILD_INDEX_HTML}

FRONTEND_BUILD_MANIFEST := ${FRONTEND_BUILD_DIR}/manifest.json
FRONTEND_BUILD_CSS := ${FRONTEND_BUILD_DIR}/index.css

${FRONTEND_BUILD_IMAGES}: ${FRONTEND_IMAGES}
	@mkdir -p ${FRONTEND_BUILD_DIR}/images
	@cp -r ${FRONTEND_IMAGES_DIR} ${FRONTEND_BUILD_DIR}
	@touch ${FRONTEND_BUILD_IMAGES}

${FRONTEND_BUILD_MANIFEST}: ${FRONTEND_PUBLIC_MANIFEST}
	@cp ${FRONTEND_PUBLIC_MANIFEST} ${FRONTEND_BUILD_MANIFEST}

${FRONTEND_BUILD_CSS}: ${FRONTEND_PUBLIC_CSS}
	@cp ${FRONTEND_PUBLIC_CSS} ${FRONTEND_BUILD_CSS}

FRONTEND_BUILD_MISC_FILES := \
	${FRONTEND_BUILD_IMAGES} \
	${FRONTEND_BUILD_INDEX_HTML} \
	${FRONTEND_BUILD_MANIFEST} \
	${FRONTEND_BUILD_CSS}

all: frontend backend

js: ${FRONTEND_BUILD_INDEX_JS}

assets: ${FRONTEND_BUILD_MISC_FILES}

${FRONTEND_BUILD_INDEX_JS}: ${FRONTEND_SRC_TS} ${FRONTEND_TSCONFIG_JSON}
	@${NPX_WEBPACK} build

${FRONTEND_BUILD}: js assets
	@touch ${FRONTEND_BUILD}

docker-frontend: ${FRONTEND_SRC}
	@${DOCKER_BUILD} \
		${DOCKERFLAGS} \
		${DOCKER_BUILD_ARGS} \
		-t "${ORG_ROOT}/${REPO}-frontend" \
		-f Dockerfile.frontend \
		.

	@touch docker-frontend

watch:
	@${NPX_WEBPACK} watch

clean:
	rm -f docker-backend docker-frontend